<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skin Decontamination Simulator</title>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .form-card, .results-card, .plot-card {
      background: #fff;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    }
    .form-group {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: bold;
      margin-bottom: 6px;
    }
    input[type="text"], input[type="number"], select {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    input[type="submit"] {
      padding: 10px 20px;
      border-radius: 5px;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }
    input[type="submit"]:hover {
      background: #0056b3;
    }
    img {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      background: #fff;
      display: block;
      margin: auto;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .plots-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      align-items: start;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .legend-note {
      font-size: 13px;
      color: #666;
      text-align: center;
    }
    @media (max-width: 900px) {
      .plots-grid {
        grid-template-columns: 1fr;
      }
    }
    .small-label {
      font-size: 13px;
      color: #555;
    }

    /* New styles for agent info cards/tables */
    .agent-card {
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfbfb 100%);
    }
    .agent-card h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    .agent-info-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .agent-info-table td {
      padding: 6px 8px;
      vertical-align: top;
      border-bottom: 1px solid #f0f0f0;
    }
    .agent-info-table td.label {
      font-weight: bold;
      width: 170px;
      color: #333;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 13px;
      color: white;
    }
    .status-above { background: #d9534f; } /* red */
    .status-below { background: #5cb85c; } /* green */
    .status-unknown { background: #6c757d; } /* gray */
    .flex-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .agent-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 700px) {
      .agent-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <h1>Skin Decontamination Simulator</h1>

  <div class="container">
    <!-- Form Card -->
    <div class="form-card">
      <form method="POST">
        <div class="form-group">
          <label for="agents">Select Agents:</label>
          <select name="agents" id="agents" multiple="multiple" style="width:100%;">
            {% for agent in agent_list %}
            <option value="{{ agent }}" {% if agent in selected_agents %} selected {% endif %}>{{ agent }}</option>
            {% endfor %}
          </select>
          <div class="small-label">Select agents from the menu.</div>
        </div>

        <div class="form-group">
          <label for="other_agents">Other Agents (Eg.Sarin, VX etc.):</label>
          <input type="text" name="other_agents" id="other_agents" value="{{ other_agents }}" placeholder="e.g. VX, Sarin">
        </div>

        <div class="form-group">
          <label for="applied_dose">Applied Dose (mg/cm²):</label>
          <input type="number" step="0.001" name="applied_dose" id="applied_dose" value="{{ applied_dose }}">
        </div>

        {% if missing_solubility %}
        <div class="form-group" style="background: #fff3cd; padding: 12px; border-radius: 5px; border: 1px solid #ffc107;">
          <h3 style="margin-top: 0; color: #856404;">⚠ Solubility Data Required</h3>
          <p style="margin-bottom: 10px; color: #856404;">The following agents are missing solubility data in the database and PubChem. Please enter the aqueous solubility (mg/cm³) for each agent:</p>
          
          {% for agent_name in missing_solubility %}
          <div style="margin-bottom: 8px;">
            <label for="solubility_{{ agent_name }}" style="display: inline-block; min-width: 200px;">{{ agent_name }}:</label>
            <input type="number" step="0.001" name="solubility_{{ agent_name }}" id="solubility_{{ agent_name }}" 
                   placeholder="e.g., 1.0" required style="width: 150px; display: inline-block;">
            <span style="font-size: 12px; color: #666;">mg/cm³</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <input type="submit" value="Simulate">
      </form>
    </div>

    <!-- Results Info -->
    {% if agent_info %}
    <div class="results-card">
      <h2 style="text-align:center;">Simulation Information</h2>

      <div class="agent-grid">
        {# Each info block is expected to be a multi-line string. We'll split and render key/value pairs #}
        {% for info in agent_info %}
        <div class="agent-card">
          {# Attempt to find the agent name for heading: look for a "Agent:" or first line #}
          {% set lines = info.splitlines() %}
          {% if lines|length > 0 %}
            {% set first_line = lines[0].strip() %}
          {% else %}
            {% set first_line = "Agent" %}
          {% endif %}

          {# Derive heading text from first line (if it starts with "Agent:", remove that portion) #}
          {% if ":" in first_line %}
            {% set heading = first_line.split(":", 1)[1].strip() %}
          {% else %}
            {% set heading = first_line %}
          {% endif %}

          <h4>{{ heading }}</h4>

          <table class="agent-info-table">
            {% for line in lines %}
              {% set raw = line.strip() %}
              {% if raw == "" %}
                {# skip empty lines #}
              {% else %}
                {# Try to split into key/value by ":" first, then "=" as fallback #}
                {% if ":" in raw %}
                  {% set parts = raw.split(":", 1) %}
                {% elif "=" in raw %}
                  {% set parts = raw.split("=", 1) %}
                {% else %}
                  {% set parts = [raw, ""] %}
                {% endif %}
                {% set key = parts[0].strip() %}
                {% set val = parts[1].strip() %}
                <tr>
                  <td class="label">{{ key }}</td>
                  <td>
                    {# Check for status-like text to show a badge #}
                    {% set low = val.lower() %}
                    {% if "above saturation" in low or "above" in low and "saturation" in low %}
                      <span class="status-badge status-above">{{ val }}</span>
                    {% elif "below saturation" in low or "below" in low and "saturation" in low %}
                      <span class="status-badge status-below">{{ val }}</span>
                    {% elif "status" == key.lower() and val == "" %}
                      <span class="status-badge status-unknown">Unknown</span>
                    {% else %}
                      {{ val }}
                    {% endif %}
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </table>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Plots -->
    <div class="plot-card">
      <h2 style="text-align:center;"></h2>
      {% if combined_images.abs_vs_evap %}
        <img src="data:image/png;base64,{{ combined_images.abs_vs_evap }}" alt="Absorption vs Evaporation">
      {% else %}
        <p style="text-align:center;color:#888;">Run a simulation to see dermal absorption results (Qabs, Qevap, Qtotal).
        The right axis shows Qtotal as % of initial dose for one reference curve.</p>
      {% endif %}
    </div>
  </div>

  <script>
    $(document).ready(function() {
      $('#agents').select2({
        placeholder: "Select agents...",
        allowClear: true,
        width: 'resolve'
      });
    });
  </script>

</body>
</html>
